# AWS SageMaker Jupyter Notebook 完全ガイド

## 📚 目次

1. [概要](#概要)
2. [前提条件](#前提条件)
3. [Step 0: AWSアカウントの発行（管理者向け）](#step-0-awsアカウントの発行管理者向け)
4. [Step 1: AWS Consoleにログイン](#step-1-aws-consoleにログイン)
5. [Step 2: SageMaker Notebook Instanceにアクセス](#step-2-sagemaker-notebook-instanceにアクセス)
6. [Step 3: ノートブックを作成](#step-3-ノートブックを作成)
   - [方法A: VS Codeで作成してアップロード](#方法a-vs-codeで作成してアップロード)
   - [方法B: JupyterLab内で直接作成](#方法b-jupyterlab内で直接作成)
7. [Step 4: ノートブックを実行](#step-4-ノートブックを実行)
8. [Step 5: 結果を確認・ダウンロード](#step-5-結果を確認ダウンロード)
9. [トラブルシューティング](#トラブルシューティング)

---

## 概要

このガイドでは、**初心者エンジニア向け**に以下の一連の流れを説明します：

```
VS CodeまたはJupyterLabでコード作成 
    ↓
AWS Consoleにログイン 
    ↓
SageMaker Jupyter Notebookにアクセス 
    ↓
ノートブックをアップロード（またはJupyterLabで直接作成） 
    ↓
実行して結果確認 
    ↓
ローカルにダウンロード
```

---

## 前提条件

### 必要なもの

- ✅ **AWSアカウント** (管理者から発行されたもの)
- ✅ **AWS認証情報** (IAMユーザー名とパスワード、またはSSOログイン情報)
- ✅ **SageMaker Notebook Instance** が起動済み
- ✅ (オプション) **VS Code** インストール済み（ローカルで開発する場合）

### 確認事項

管理者から以下の情報を受け取っているか確認:

- AWS Account ID: `123456789012` (例)
- IAM User Name: `your-username`
- 初期パスワード（初回ログイン後に変更が必要）
- SageMaker Notebook Instance名: `k2i-aras-ml-notebook`
- S3 Bucket名: `k2i-aras-ml-data-<アカウントID>`

---

## Step 0: AWSアカウントの発行（管理者向け）

> **注意**: このセクションは**管理者またはチームリーダー**のみが実行します。  
> 一般ユーザーは [Step 1](#step-1-aws-consoleにログイン) から開始してください。

### 0.1 IAMユーザーグループの確認

#### 既存のユーザーグループを確認

1. AWS Consoleにログイン（管理者アカウント）
2. 検索バーに `IAM` と入力 → `IAM` サービスをクリック
3. 左サイドバー: `User groups` をクリック
4. 既存のグループを確認:
   - **`K2I-ARAS-ML-Users`** (機械学習ユーザー用グループ)

### 0.2 新規IAMユーザーの作成

#### 0.2.1 ユーザー作成を開始

1. IAMダッシュボード → 左サイドバー: `Users` をクリック
2. `Create user` ボタンをクリック

#### 0.2.2 ユーザー詳細を入力

**Step 1: Specify user details**

- **User name**: `tanaka-taro` (例: 社員名)
- ✅ **Provide user access to the AWS Management Console** にチェック
- **Console password**: 
  - `Autogenerated password` (自動生成) **推奨**
  - または `Custom password` (カスタムパスワード)
- ✅ **Users must create a new password at next sign-in** にチェック（推奨）
- `Next` をクリック

#### 0.2.3 ユーザーグループに追加

**Step 2: Set permissions**

- `Add user to group` を選択
- ✅ **`K2I-ARAS-ML-Users`** にチェック
- `Next` をクリック

#### 0.2.4 タグを追加（オプション）

**Step 3: Add tags (optional)**

- **Key**: `Department`, **Value**: `ARAS-ML`
- **Key**: `Project`, **Value**: `K2I-Machine-Learning`
- `Next` をクリック

#### 0.2.5 確認して作成

**Step 4: Review and create**

- 設定内容を確認
- `Create user` をクリック

#### 0.2.6 認証情報を取得

**重要**: この画面は1回しか表示されません!

1. `Download .csv file` をクリックして認証情報をダウンロード
2. または、画面に表示された以下の情報をメモ:
   - **Console sign-in URL**: `https://<アカウントID>.signin.aws.amazon.com/console`
   - **User name**: `tanaka-taro`
   - **Console password**: `Ab3#xY...` (自動生成された場合)

### 0.3 新規ユーザーへの情報共有

新規ユーザーに以下の情報を**安全な方法**（社内チャット、メールなど）で共有:

```
【AWS SageMaker アクセス情報】

■ ログイン情報
AWS Console URL: https://123456789012.signin.aws.amazon.com/console
IAM User Name: tanaka-taro
初期パスワード: Ab3#xY... (初回ログイン後に変更してください)

■ リソース情報
リージョン: Asia Pacific (Tokyo) ap-northeast-1
SageMaker Notebook Instance: k2i-aras-ml-notebook
S3 Bucket: k2i-aras-ml-data-123456789012

■ 初回ログイン手順
1. 上記のURLにアクセス
2. IAM User Nameとパスワードを入力
3. 新しいパスワードを設定
4. SageMakerにアクセス
```

---

## Step 1: AWS Consoleにログイン

### 1.1 ブラウザでAWS Consoleを開く

1. ブラウザ（Chrome/Edgeを推奨）を開く
2. 以下のURLにアクセス:
   - **通常**: https://console.aws.amazon.com/
   - **SSO**: 会社から提供されたSSOログインURL

### 1.2 認証情報を入力

#### パターンA: IAMユーザーログイン（推奨）

```
1. Console sign-in URL: https://<アカウントID>.signin.aws.amazon.com/console
   （管理者から提供されたURL）
2. IAM user name: <あなたのユーザー名>（例: tanaka-taro）
3. Password: <パスワード>
```

**初回ログイン時**: パスワード変更を求められます
- 現在のパスワード: （管理者から受け取ったもの）
- 新しいパスワード: （8文字以上、大小英字・数字・記号を含む）
- 確認: （新しいパスワードを再入力）

#### パターンB: SSOログイン

```
1. 会社のSSOログインページにアクセス
2. メールアドレスとパス��ードを入力
3. 多要素認証（MFA）コードを入力
4. AWS Consoleにリダイレクトされる
```

### 1.3 リージョンを確認

- 画面右上のリージョン名を確認
- **東京リージョン (ap-northeast-1)** が選択されているか確認
- 違う場合: クリックして `Asia Pacific (Tokyo) ap-northeast-1` を選択

---

## Step 2: SageMaker Notebook Instanceにアクセス

### 2.1 SageMakerサービスを開く

1. 画面上部の検索バーに `SageMaker` と入力
2. `Amazon SageMaker` をクリック

![SageMaker Search](https://docs.aws.amazon.com/sagemaker/latest/dg/images/console-search.png)

### 2.2 Notebook Instancesページに移動

1. 左サイドバーの `Notebook` セクション
2. `Notebook instances` をクリック

### 2.3 Notebook Instanceの状態を確認

| 状態 | 意味 | アクション |
|------|------|------------|
| **InService** (緑) | 起動中・利用可能 | そのまま次へ |
| **Stopped** (グレー) | 停止中 | `Start` ボタンをクリックして起動 (5-10分かかる) |
| **Pending** (オレンジ) | 起動中 | 待機（数分で InService になる） |

### 2.4 JupyterLabを開く

1. Notebook Instance名: **`k2i-aras-ml-notebook`** を探す
2. 右側の `Actions` 列で **`Open JupyterLab`** をクリック

![Open JupyterLab](https://docs.aws.amazon.com/sagemaker/latest/dg/images/notebook-instances-open-jupyter.png)

### 2.5 新しいタブでJupyterLabが開く

- 左側にファイルブラウザ
- 右側に作業エリア

---

## Step 3: ノートブックを作成

### 方法A: VS Codeで作成してアップロード

ローカルPCでコードを編集したい場合に推奨。

#### A.1 VS Codeでノートブックを作成

1. **VS Code**を起動
2. `File` → `Open Folder...`
3. プロジェクトフォルダを選択: `d:\日本課題\K2I\Projects\aws_k2i_aras_dev`
4. `examples` フォルダを右クリック → `New File`
5. ファイル名: `my-training.ipynb` と入力
6. `+ Code` をクリックしてセルを追加
7. コードを記述
8. `Ctrl + S` で保存

#### A.2 JupyterLabにアップロード（ドラッグ&ドロップ）

1. **ローカルPC**でエクスプローラーを開く
2. `d:\日本課題\K2I\Projects\aws_k2i_aras_dev\examples\my-training.ipynb` を探す
3. ファイルを選択して、**JupyterLabのファイルブラウザにドラッグ&ドロップ**

![Drag and Drop](https://jupyter.readthedocs.io/en/latest/_images/file-browser-upload.png)

4. ファイルブラウ��に `my-training.ipynb` が表示されることを確認

---

### 方法B: JupyterLab内で直接作成（推奨）

ブラウザ内ですべて完結できます。

#### B.1 新しいノートブックを作成

1. JupyterLabの左側ファイルブラウザで、作業したいフォルダをダブルクリック
2. 上部メニュー: `File` → `New` → `Notebook`

**または:**

1. 画面中央の **`Launcher`** タブ（開いていない場合: `File` → `New Launcher`）
2. `Notebook` セクションで **`Python 3 (ipykernel)`** をクリック

#### B.2 カーネルを選択

- カーネル選択ダイアログが表示された場合:
  - **`conda_pytorch_p310`** を選択（PyTorch環境、推奨）
  - または **`conda_tensorflow2_p310`** (TensorFlow環境)
  - `Select` をクリック

#### B.3 ノートブック名を変更

1. 上部の **`Untitled.ipynb`** を右クリック
2. `Rename` を選択
3. 新しい名前を入力: `my-training.ipynb`
4. Enter キーを押す

#### B.4 コードセルを追加

1. 最初のセルが自動的に作成されている（`[ ]` が表示されている）
2. セルの種類を確認:
   - **Code**: Pythonコードを実行
   - **Markdown**: テキスト・説明を記述

セル種類の変更方法:
- ��ルを選択してツールバーのドロップダウンから選択
- または: セル選択時に `M` キー（Markdown）、`Y` キー（Code）

#### B.5 コードを記述

**例: 環境確認セル**

セルに以下を入力:

```python
import torch
import sys

print(f"Python version: {sys.version}")
print(f"PyTorch version: {torch.__version__}")
print(f"CUDA available: {torch.cuda.is_available()}")
if torch.cuda.is_available():
    print(f"GPU device: {torch.cuda.get_device_name(0)}")
```

#### B.6 新しいセルを追加

- 現在のセルの下に追加: `B` キー
- 現在のセルの上に追加: `A` キー
- または: ツールバーの `+` ボタンをクリック

#### B.7 ノートブックを保存

- `Ctrl + S` (Windows) または `Cmd + S` (Mac)
- または: `File` → `Save Notebook`

**自動保存**: JupyterLabは数分おきに自動保存されます

---

## Step 4: ノートブックを実行

### 4.1 ノートブックを開く

1. JupyterLabのファイルブラウザでノートブックファイルをダブルクリック
   - 例: `aws-ml-training-full-sample.ipynb`
   - または: `my-training.ipynb`
2. ノートブックが右側のエディタで開く

### 4.2 カーネルを選択・確認

#### カーネル選択ダイアログが表示された場合:

1. **`conda_pytorch_p310`** を選択（PyTorch環境、推奨）
2. または **`conda_tensorflow2_p310`** (TensorFlow環境)
3. `Select` をクリック

#### 手動でカーネルを確認・変更する場合:

1. 右上のカーネル名を確認（例: `Python 3 (ipykernel)` または `conda_pytorch_p310`）
2. クリックしてカーネル選択メニューを開く
3. `conda_pytorch_p310` を選択

### 4.3 セルを実行

#### 方法A: 1セルずつ実行（推奨）

1. 実行したいセルをクリック
2. **`Shift + Enter`** を押す
   - セルが実行される
   - 出力がセルの下に表示される
   - 次のセルに自動移動
3. 出力を確認してから次のセルへ進む

**キーボードショートカット:**
- `Shift + Enter`: セル実行 → 次のセルへ移動
- `Ctrl + Enter`: セル実行 → 同じセルに留まる
- `Alt + Enter`: セル実行 → 下に新しいセルを追加

#### 方法B: すべてのセルを一度に実行

1. 上部メニューの **`Run`** をクリック
2. **`Run All Cells`** を選択
3. すべてのセルが順番に実行される

⚠️ **注意**: エラーが発生した場合、それ以降のセルも影響を受ける可能性があ���ます。

#### 方法C: 選択したセルから最後まで実行

1. 実行を開始したいセルをクリック
2. `Run` → `Run Selected Cell and All Below`
3. そのセルから最後まで順番に実行される

### 4.4 実行状態の確認

セルの左側に表示される記号:

| 表示 | 意味 |
|------|------|
| `[ ]` | 未実行 |
| `[*]` | 実行中（処理中） |
| `[1]` | 実行完了（数字は実行順序） |

### 4.5 実行を中断する方法

長時間実行されているセルを停止したい場合:

1. **停止ボタン**: ツールバーの ⬛ (停止) アイコンをクリック
2. **カーネル再起動**: `Kernel` → `Restart Kernel`

### 4.6 出力の確認

各セルの実行後、セルの下に出力が表示されます:

- **テキスト出力**: `print()` の結果
- **グラフ・画像**: matplotlib のプロット
- **エラーメッセージ**: 赤色のトレースバック

**出力のクリア:**
- 1つのセル: セルを右クリック → `Clear Outputs`
- すべてのセル: `Edit` → `Clear All Outputs`

---

## Step 5: 結果を確認・ダウンロード

### 5.1 JupyterLab内で結果を確認

#### 出力を確認

ノートブック内で各セルの出力を確認:

- **テキスト出力**: 数値、ログメッセージ
- **グラフ**: 学習曲線、予測結果の可視化
- **JSON**: 学習サマリー

#### ファイルを確認

左側のファイルブラウザで生成されたファイルを確認:

```
SageMaker/
├── models/
│   └── mnist_cnn_<timestamp>.pth
└── outputs/
    ├── training_curves_<timestamp>.png
    ├── sample_predictions_<timestamp>.png
    └── training_summary_<timestamp>.json
```

### 5.2 S3で結果を確認

#### 5.2.1 AWS ConsoleでS3を開く

1. AWS Console検索バーに `S3` と入力
2. `S3` サービスをクリック

#### 5.2.2 バケットを開く

1. バケット一覧から `k2i-aras-ml-data-<アカウントID>` をクリック

#### 5.2.3 保存されたファイルを確認

フォルダ構造を確認:

```
k2i-aras-ml-data-123456789012/
├── models/
│   └── mnist_cnn_20260213_143022.pth  (約 4.7 MB)
└── outputs/
    ├── training_curves_20260213_143022.png  (約 50 KB)
    ├── sample_predictions_20260213_143022.png  (約 30 KB)
    └── training_summary_20260213_143022.json  (約 1 KB)
```

### 5.3 ローカルPCにダウンロード

#### 方法A: JupyterLabから直接ダウンロード（推奨）

1. JupyterLabのファイルブラウザで以下のファイルを探す:
   - `models/mnist_cnn_<timestamp>.pth`
   - `outputs/training_curves_<timestamp>.png`
   - `outputs/sample_predictions_<timestamp>.png`

2. ファイルを右クリック → `Download` を選択

3. ローカルPCの `ダウンロード` フォルダに保存される

#### 方法B: S3からダウンロード

1. AWS Console → S3バケットでファイルを選択
2. ファイル名の左側の☑にチェック
3. 右上の `Download` ボタンをクリック
4. ローカルPCに保存される

---

## トラブルシューティング

### ❌ 問題1: JupyterLabが開かない

#### 症状
- `Open JupyterLab` をクリックしても何も起こらない

#### 原因
- ポップアップブロッカーがブロックしている

#### 解決方法
```
1. ブラウザのアドレスバー右側のアイコンを確認
2. 「ポップアップがブロックされました」が表示されている場合
3. 「許可」をクリック
4. 再度 `Open JupyterLab` をクリック
```

---

### ❌ 問題2: GPUが認識されない

#### 症状
```python
CUDA available: False
⚠️ GPU not available. Running on CPU.
```

#### 原因
- インスタンスタイプがCPUのみ（ml.t3.medium など）
- カーネルが正しくない

#### 解決方法

**方法A: インスタンスタイプを確認**
```
1. AWS Console → SageMaker → Notebook instances
2. インスタンスタイプを確認
3. ml.g5.xlarge または ml.g4dn.xlarge になっているか
4. 違う場合: インスタンスを停止 → 設定変更 → 再起動
```

**方法B: カーネルを変更**
```
1. JupyterLabで Kernel → Change Kernel
2. conda_pytorch_p310 を選択
3. すべてのセルを再実行
```

---

### ❌ 問題3: S3アップロードエラー

#### 症状
```python
❌ Upload failed: An error occurred (AccessDenied)
```

#### 原因
- IAMロールにS3への書き込み権限がない
- バケット名が間違っている

#### 解決方法

**方法A: IAMロールを確認**
```
1. AWS Console → SageMaker → Notebook instances
2. インスタンス名をクリック
3. "Permissions and encryption" セクションを確認
4. IAM role に AmazonS3FullAccess が付与されているか確認
```

**方法B: バケット名を確認**
```python
# ノートブック内で実行
print(f"Account ID: {account_id}")
print(f"Bucket name: {bucket_name}")

# 正しいバケットが存在するか確認
aws s3 ls s3://k2i-aras-ml-data-{account_id}/
```

---

### ❌ 問題4: メモリ不足エラー

#### 症状
```
CUDA out of memory. Tried to allocate X.XX GiB
```

#### 原因
- バッチサイズが大きすぎる
- モデルが大きすぎる

#### 解決方法

**バッチサイズを減らす:**
```python
# 変更前
batch_size = 64

# 変更後
batch_size = 32  # または 16
```

**メモリをクリア:**
```python
# セルの最初に追加
import torch
torch.cuda.empty_cache()
```

---

### ❌ 問題5: カーネルが応答しない

#### 症状
- セルが `[*]` のまま長時間止まっている
- 何も出力されない

#### 解決方法

**方法A: カーネルを再起動**
```
1. 上部メニュー: Kernel → Restart Kernel
2. "Restart" をクリックして確認
3. セルを最初から再実行
```

**方法B: Notebook Instanceを再起動**
```
1. AWS Console → SageMaker → Notebook instances
2. インスタンスを選択
3. Actions → Stop
4. 停止後、Actions → Start
5. 5-10分待って再度 Open JupyterLab
```

---

### ❌ 問題6: ファイルが見つからない

#### 症状
```python
FileNotFoundError: [Errno 2] No such file or directory: './models/...'
```

#### 原因
- ディレクトリが作成されていない
- パスが間違っている

#### 解決方法

**ディレクトリを手動作成:**
```python
import os
os.makedirs('./models', exist_ok=True)
os.makedirs('./outputs', exist_ok=True)
os.makedirs('./data', exist_ok=True)
```

**現在のディレクトリを確認:**
```python
import os
print(f"Current directory: {os.getcwd()}")
print(f"Files: {os.listdir('.')}")
```

---

## ✅ チェックリスト

実行前に以下を確認してください:

- [ ] AWSアカウント情報を受け取っている（IAMユーザー名・パスワード）
- [ ] AWS Consoleにログインできる
- [ ] リージョンが **東京 (ap-northeast-1)** になっている
- [ ] SageMaker Notebook Instanceが **InService** 状態
- [ ] インスタンスタイプが **ml.g5.xlarge** または **ml.g4dn.xlarge**
- [ ] JupyterLabが開ける
- [ ] ノートブックファイルが作成またはアップロード済み
- [ ] カーネルが **conda_pytorch_p310** に設定されている

---

**作成日**: 2026年2月13日